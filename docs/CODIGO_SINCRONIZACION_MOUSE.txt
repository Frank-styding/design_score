// PARTE 1: CAPTURA DE EVENTOS (sender) - Reemplazar líneas 355-395 aproximadamente

              var syncEnabled = false;
              var lastSentX = -1;
              var lastSentY = -1;
              var isReceivingSync = false;
              var isDragging = false;
              
              var originalRaMethod = keyshotXR.Ra;
              keyshotXR.Ra = function() {
                originalRaMethod.call(keyshotXR);
                
                var container = document.getElementById("${cfg.nameOfDiv}");
                if (container) {
                  // Escuchar mousedown
                  container.addEventListener("mousedown", function(e) {
                    if (!syncEnabled || isReceivingSync) return;
                    
                    isDragging = true;
                    
                    var rect = container.getBoundingClientRect();
                    var relativeX = (e.clientX - rect.left) / rect.width;
                    var relativeY = (e.clientY - rect.top) / rect.height;
                    
                    lastSentX = relativeX;
                    lastSentY = relativeY;
                    
                    console.log("MOUSEDOWN desde ${cfg.nameOfDiv} - x:", relativeX.toFixed(3), "y:", relativeY.toFixed(3));
                    
                    window.parent.postMessage({
                      type: "keyshot-mouse-down",
                      containerId: "${cfg.nameOfDiv}",
                      relativeX: relativeX,
                      relativeY: relativeY
                    }, "*");
                  });
                  
                  // Escuchar mousemove
                  container.addEventListener("mousemove", function(e) {
                    if (!syncEnabled || isReceivingSync || !isDragging) return;
                    
                    var rect = container.getBoundingClientRect();
                    var relativeX = (e.clientX - rect.left) / rect.width;
                    var relativeY = (e.clientY - rect.top) / rect.height;
                    
                    if (Math.abs(relativeX - lastSentX) > 0.005 || Math.abs(relativeY - lastSentY) > 0.005) {
                      lastSentX = relativeX;
                      lastSentY = relativeY;
                      
                      console.log("MOUSEMOVE desde ${cfg.nameOfDiv} - x:", relativeX.toFixed(3), "y:", relativeY.toFixed(3));
                      
                      window.parent.postMessage({
                        type: "keyshot-mouse-move",
                        containerId: "${cfg.nameOfDiv}",
                        relativeX: relativeX,
                        relativeY: relativeY
                      }, "*");
                    }
                  });
                  
                  // Escuchar mouseup
                  container.addEventListener("mouseup", function(e) {
                    if (!syncEnabled || isReceivingSync) return;
                    
                    isDragging = false;
                    
                    var rect = container.getBoundingClientRect();
                    var relativeX = (e.clientX - rect.left) / rect.width;
                    var relativeY = (e.clientY - rect.top) / rect.height;
                    
                    console.log("MOUSEUP desde ${cfg.nameOfDiv} - x:", relativeX.toFixed(3), "y:", relativeY.toFixed(3));
                    
                    window.parent.postMessage({
                      type: "keyshot-mouse-up",
                      containerId: "${cfg.nameOfDiv}",
                      relativeX: relativeX,
                      relativeY: relativeY
                    }, "*");
                  });
                  
                  console.log("Sistema de sincronización por mouse configurado para:", "${cfg.nameOfDiv}");
                }

// PARTE 2: RECEPTOR DE EVENTOS (receiver) - Reemplazar líneas 410-460 aproximadamente

              window.addEventListener("message", function(event) {
                var data = event.data;
                
                if (data.type === "keyshot-sync-enable") {
                  syncEnabled = data.enabled;
                  console.log("Sincronización " + (syncEnabled ? "habilitada" : "deshabilitada") + " en: ${cfg.nameOfDiv}");
                }
                
                // Recibir MOUSEDOWN
                if (data.type === "keyshot-mouse-down" && syncEnabled) {
                  if (data.containerId === "${cfg.nameOfDiv}") return;
                  
                  console.log("Recibiendo MOUSEDOWN en ${cfg.nameOfDiv}");
                  
                  isReceivingSync = true;
                  isDragging = true;
                  
                  var container = document.getElementById("${cfg.nameOfDiv}");
                  if (container) {
                    var rect = container.getBoundingClientRect();
                    var absoluteX = rect.left + (data.relativeX * rect.width);
                    var absoluteY = rect.top + (data.relativeY * rect.height);
                    
                    var mouseDownEvent = new MouseEvent('mousedown', {
                      bubbles: true,
                      cancelable: true,
                      view: window,
                      clientX: absoluteX,
                      clientY: absoluteY,
                      pageX: absoluteX + window.pageXOffset,
                      pageY: absoluteY + window.pageYOffset,
                      button: 0,
                      buttons: 1
                    });
                    
                    container.dispatchEvent(mouseDownEvent);
                  }
                  
                  setTimeout(function() { isReceivingSync = false; }, 50);
                }
                
                // Recibir MOUSEMOVE
                if (data.type === "keyshot-mouse-move" && syncEnabled) {
                  if (data.containerId === "${cfg.nameOfDiv}") return;
                  
                  console.log("Recibiendo MOUSEMOVE en ${cfg.nameOfDiv}");
                  
                  isReceivingSync = true;
                  
                  var container = document.getElementById("${cfg.nameOfDiv}");
                  if (container) {
                    var rect = container.getBoundingClientRect();
                    var absoluteX = rect.left + (data.relativeX * rect.width);
                    var absoluteY = rect.top + (data.relativeY * rect.height);
                    
                    var mouseMoveEvent = new MouseEvent('mousemove', {
                      bubbles: true,
                      cancelable: true,
                      view: window,
                      clientX: absoluteX,
                      clientY: absoluteY,
                      pageX: absoluteX + window.pageXOffset,
                      pageY: absoluteY + window.pageYOffset,
                      buttons: 1
                    });
                    
                    container.dispatchEvent(mouseMoveEvent);
                  }
                  
                  setTimeout(function() { isReceivingSync = false; }, 50);
                }
                
                // Recibir MOUSEUP
                if (data.type === "keyshot-mouse-up" && syncEnabled) {
                  if (data.containerId === "${cfg.nameOfDiv}") return;
                  
                  console.log("Recibiendo MOUSEUP en ${cfg.nameOfDiv}");
                  
                  isReceivingSync = true;
                  isDragging = false;
                  
                  var container = document.getElementById("${cfg.nameOfDiv}");
                  if (container) {
                    var rect = container.getBoundingClientRect();
                    var absoluteX = rect.left + (data.relativeX * rect.width);
                    var absoluteY = rect.top + (data.relativeY * rect.height);
                    
                    var mouseUpEvent = new MouseEvent('mouseup', {
                      bubbles: true,
                      cancelable: true,
                      view: window,
                      clientX: absoluteX,
                      clientY: absoluteY,
                      pageX: absoluteX + window.pageXOffset,
                      pageY: absoluteY + window.pageYOffset,
                      button: 0,
                      buttons: 0
                    });
                    
                    container.dispatchEvent(mouseUpEvent);
                  }
                  
                  setTimeout(function() { isReceivingSync = false; }, 50);
                }
              });

// PARTE 3: ACTUALIZAR OptimizedViewerPool.tsx para manejar los 3 tipos de mensajes

En src/components/OptimizedViewerPool.tsx, buscar el handleIndexChanged y reemplazar por:

const handleIndexChanged = (event: MessageEvent) => {
  if (
    event.data.type === "keyshot-mouse-down" ||
    event.data.type === "keyshot-mouse-move" ||
    event.data.type === "keyshot-mouse-up"
  ) {
    const { containerId, relativeX, relativeY } = event.data;
    
    console.log(`Propagando ${event.data.type} desde ${containerId}`);
    
    iframesRef.current.forEach((iframe, productId) => {
      if (iframe.contentWindow) {
        iframe.contentWindow.postMessage(
          {
            type: event.data.type,
            containerId: containerId,
            relativeX: relativeX,
            relativeY: relativeY,
          },
          "*"
        );
      }
    });
  }
};
